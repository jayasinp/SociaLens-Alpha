{% extends "base.html" %}

{% block title %}Data Upload{% endblock %}

{% block content %}
<h3>Network Visualiser</h3>
<!-- Add dropdown menu for file selection -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<!-- SVG container for the network visualization -->
<svg id="network" style="background-color: rgb(195, 200, 221);"></svg>

<script>
 
//name a tooltip_in function to call when the mouse hovers a node
tooltip_in = function(event, d) { // pass event and d to this function so that it can access d for our data
    return tooltip
        .html("<h4>ID: " + d.id + "</h4>") // add an html element with a header tag containing the name of the node. Other details can be added here
        .style("opacity", "1") // make the tooltip visible on hover
        .style("top", event.pageY + "px") // position the tooltip with its top at the same pixel location as the mouse on the screen
        .style("left", event.pageX + "px"); // position the tooltip just to the right of the mouse location
}
// name a tooltip_out function to call when the mouse stops hovering
tooltip_out = function() {
    return tooltip
        .transition()
        .duration(200) // give the hide behavior a delay so that it doesn't jump around as the network moves
        .style("opacity", "0"); // hide the tooltip when the mouse stops hovering
}
  // Define the zoom behavior
  var zoom = d3.zoom()
    .scaleExtent([0.5, 10]) // Set the zoom scale extent
    .on("zoom", zoomed);
// Set up SVG dimensions
const width = window.innerWidth*0.8;
const height = window.innerHeight*0.8;
// Append the SVG object to the container and apply zoom behavior
  var svg = d3.select("#network")
    .attr('width', width)
    .attr('height', height)
    .call(zoom)
    .append("g");

// Fetch the selected filename
const selectedFilename = "{{ selected_filename }}";

            d3.json(`/get_network_json_data/${selectedFilename}`).then(function(data) {    
                // Create force simulation
                const simulation = d3.forceSimulation(data.nodes)
                    .force('link', d3.forceLink(data.links).id(d => d.id))
                    .force('charge', d3.forceManyBody().strength(-50))
                    .force('center', d3.forceCenter(width / 2, height / 2));

                // Create links
                const link = svg.selectAll('.link')
                    .data(data.links)
                    .enter().append('line')
                    .attr('class', 'link')
                    .style('stroke', '#999')
                    .style('stroke-opacity', 0.8);
                
                var color = d3.scaleOrdinal(d3.schemeCategory10);

                // Create nodes
                const node = svg.selectAll('.node')
                    .data(data.nodes)
                    .enter().append('circle')
                    .attr('class', 'node')
                    .attr('r', 7)
                    //.attr('fill', 'blue')
                    .style("fill", function (d) { return color(d.group); })
                    .call(drag(simulation))
                    .on("mouseover", tooltip_in) // when the mouse hovers a node, call the tooltip_in function to create the tooltip
                    .on("mouseout", tooltip_out); // when the mouse stops hovering a node, call the tooltip_out function to get rid of the tooltip //https://observablehq.com/@mkane2/force-directed-graph-with-tooltip;

                // name a variable tooltip, and style it using css properties
                tooltip = d3
                    .select("body")
                    .append("div") // the tooltip always "exists" as its own html div, even when not visible
                    .attr("class", "tooltip")
                    .style("position", "absolute") // the absolute position is necessary so that we can manually define its position later
                    .style("opacity", "0") // hide it from default at the start so it only appears on hover
                    .style("background-color", "white")
                    .style("font-family", "sans-serif")
                    .style("padding", "5px")
                    .style("border-radius", "5px")
                    .style("border", "1px solid grey")
                    .style("z-index", 9999); // Set a high z-index value to ensure it appears on top;

                // Add drag behavior
                function drag(simulation) {
                    function dragstarted(event) {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        event.subject.fx = event.subject.x;
                        event.subject.fy = event.subject.y;
                    }

                    function dragged(event) {
                        event.subject.fx = event.x;
                        event.subject.fy = event.y;
                    }

                    function dragended(event) {
                        if (!event.active) simulation.alphaTarget(0);
                        event.subject.fx = null;
                        event.subject.fy = null;
                    }

                    return d3.drag()
                        .on('start', dragstarted)
                        .on('drag', dragged)
                        .on('end', dragended);
                }
                // Add tick function for updating positions
                simulation.on('tick', () => {
                    link.attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);

                    node.attr('cx', d => d.x)
                        .attr('cy', d => d.y);
                });
            });


// Zoomed function to update SVG transform
function zoomed(event) {
svg.attr("transform", event.transform);
}
</script>
{% endblock %}

